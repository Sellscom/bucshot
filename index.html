<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        #main-menu { position: absolute; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 10px solid #5d3a1a; }
        #game-ui { position: relative; width: 100vw; height: 100vh; max-width: 500px; border: 8px solid #5d3a1a; display: none; flex-direction: column; }
        .hp-bar { display: flex; gap: 5px; padding: 10px; background: #000; justify-content: center; border-bottom: 2px solid #5d3a1a; }
        .hp-unit { width: 20px; height: 30px; border: 1px solid #fff; background: #f00; }
        .hp-unit.empty { background: #222; }
        #table { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #gun { width: 70%; transition: transform 0.3s; z-index: 5; }
        .status { background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0; color: #0f0; margin: 10px; text-align: center; width: 80%; font-size: 14px; }
        .inv { display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; background: #111; justify-content: center; border-top: 2px solid #5d3a1a; min-height: 50px; }
        .item { width: 45px; height: 45px; background: #222; border: 1px solid #5d3a1a; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .btn { padding: 15px; background: #1a1a1a; border: 2px solid #5d3a1a; color: #fff; font-weight: bold; cursor: pointer; }
        .btn:disabled { opacity: 0.2; }
    </style>
</head>
<body>

    <audio id="m_bg" src="https://thelongdark.su/files/music/bg.mp3" loop></audio>
    <audio id="s_live" src="https://www.myinstants.com/media/sounds/heavy-shotgun-shot.mp3"></audio>
    <audio id="s_blank" src="https://www.myinstants.com/media/sounds/empty-gun-shot.mp3"></audio>

    <div id="main-menu">
        <h1 style="color:#8b5a2b">BUCKSHOT ONLINE</h1>
        <button class="btn" style="width:200px" onclick="initMulti()">ИГРАТЬ</button>
        <p id="st">ОЖИДАНИЕ...</p>
    </div>

    <div id="game-ui">
        <div class="hp-bar" id="opp-hp"></div>
        <div id="table">
            <div id="info" class="status">ПОДГОТОВКА...</div>
            <img id="gun" src="https://i.imgur.com/8mX3BfT.png">
        </div>
        <div style="text-align:center; font-size:12px; padding:5px;">БОЕВЫЕ: <span id="l-c" style="color:red">0</span> | ХОЛОСТЫЕ: <span id="b-c" style="color:gray">0</span></div>
        <div class="hp-bar" id="my-hp"></div>
        <div class="inv" id="my-inv"></div>
        <div class="controls">
            <button id="b-self" class="btn" onclick="fire('self')">В СЕБЯ</button>
            <button id="b-opp" class="btn" onclick="fire('opponent')">В ВРАГА</button>
        </div>
    </div>

<script>
    const socket = io("https://bucshot.onrender.com");
    let room = null;
    let state = { myHP: 3, oppHP: 3, mag: [], turn: false, inv: [] };

    function initMulti() {
        document.getElementById('st').innerText = "ПОИСК...";
        socket.emit('join_game');
    }

    socket.on('start_multiplayer', (data) => {
        room = data.id;
        state.mag = data.magazine;
        state.turn = (data.turn === socket.id);
        state.inv = data.myInv;
        
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('m_bg').play().catch(() => {});
        updateUI();
    });

    socket.on('opponent_move', (data) => {
        const bullet = state.mag.shift();
        animShot(data.target === 'self' ? 'opponent' : 'self', bullet, false);
    });

    socket.on('reload_magazine', (data) => {
        state.mag = data.magazine;
        state.inv = [...state.inv, ...data.newItems].slice(0, 8);
        document.getElementById('info').innerText = "МАГАЗИН ПЕРЕЗАРЯЖЕН!";
        updateUI();
    });

    function updateUI() {
        const hp = (id, n) => {
            const el = document.getElementById(id); el.innerHTML = '';
            for(let i=0; i<3; i++) el.innerHTML += `<div class="hp-unit ${i>=n?'empty':''}"></div>`;
        };
        hp('my-hp', state.myHP);
        hp('opp-hp', state.oppHP);

        const invEl = document.getElementById('my-inv'); invEl.innerHTML = '';
        state.inv.forEach((it) => {
            const d = document.createElement('div'); d.className = 'item';
            d.innerText = it; d.onclick = () => alert("Предмет: " + it);
            invEl.appendChild(d);
        });

        document.getElementById('l-c').innerText = state.mag.filter(b => b).length;
        document.getElementById('b-c').innerText = state.mag.filter(b => !b).length;
        document.getElementById('info').innerText = state.turn ? "ВАШ ХОД" : "ХОД ВРАГА";
        document.getElementById('b-self').disabled = !state.turn;
        document.getElementById('b-opp').disabled = !state.turn;
    }

    function fire(target) {
        if (!state.turn) return;
        const bullet = state.mag.shift();
        socket.emit('make_move', { roomId: room, target, bullet, type: 'shoot' });
        animShot(target, bullet, true);
    }

    function animShot(target, live, isMe) {
        state.turn = false;
        updateUI();
        const g = document.getElementById('gun');
        if (isMe) g.style.transform = target === 'self' ? 'rotate(180deg) translateY(20px)' : 'translateX(30px)';
        else g.style.transform = target === 'self' ? 'translateX(-30px)' : 'rotate(180deg) translateY(-20px)';

        setTimeout(() => {
            const s = live ? document.getElementById('s_live') : document.getElementById('s_blank');
            s.currentTime = 0; s.play();

            if (live) {
                if (target === 'self') isMe ? state.myHP-- : state.oppHP--;
                else isMe ? state.oppHP-- : state.myHP--;
            }
            
            setTimeout(() => {
                g.style.transform = 'none';
                state.turn = !isMe || (!live && target === 'self');
                updateUI();
                if (state.myHP <= 0 || state.oppHP <= 0) { alert("КОНЕЦ"); location.reload(); }
            }, 600);
        }, 400);
    }
</script>
</body>
</html>
