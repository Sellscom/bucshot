<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; user-select: none; }
        
        /* Меню */
        #main-menu { position: absolute; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid #5d3a1a; box-sizing: border-box; }
        .btn { padding: 15px; width: 220px; margin: 5px; background: #1a1a1a; border: 2px solid #5d3a1a; color: #fff; font-weight: bold; cursor: pointer; }
        
        /* Игра */
        #game-ui { position: relative; width: 100%; height: 100%; max-width: 500px; display: none; flex-direction: column; border: 4px solid #5d3a1a; background: #0a0a0a; }
        
        .hp-section { background: #000; padding: 10px; border-bottom: 1px solid #333; display: flex; flex-direction: column; align-items: center; }
        .hp-bar { display: flex; gap: 5px; margin: 5px 0; }
        .hp-icon { width: 22px; height: 32px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        .opp-inv { display: flex; gap: 4px; opacity: 0.7; height: 30px; }
        .item-mini { width: 25px; height: 25px; border: 1px solid #444; background-size: contain; background-repeat: no-repeat; }

        #table { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; }
        #gun { width: 70%; transition: transform 0.4s; z-index: 10; }
        #info-box { position: absolute; top: 10%; background: rgba(0,0,0,0.8); border: 1px solid #0f0; color: #0f0; padding: 10px; z-index: 20; text-align: center; width: 80%; }

        .item-alert { position: absolute; color: #ff0; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; animation: fade 2s forwards; z-index: 100; pointer-events: none; }
        @keyframes fade { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-60px); } }

        #player-area { background: #111; padding: 10px; border-top: 2px solid #5d3a1a; }
        .inventory { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; min-height: 50px; margin: 10px 0; }
        .item-btn { width: 45px; height: 45px; border: 1px solid #5d3a1a; background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #1a1a1a; cursor: pointer; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-act { padding: 15px; background: #222; border: 1px solid #5d3a1a; color: #fff; font-weight: bold; }
        .btn-act:disabled { opacity: 0.2; }

        .flash { position: absolute; width: 100%; height: 100%; background: #fff; opacity: 0; z-index: 50; pointer-events: none; }
    </style>
</head>
<body>

    <audio id="snd-bg" src="background_music.mp3" loop></audio>
    <audio id="snd-live" src="shot_live.mp3"></audio>
    <audio id="snd-blank" src="shot_blank.mp3"></audio>
    <audio id="snd-reload" src="reload.mp3"></audio>
    <audio id="snd-item" src="item_use.mp3"></audio>

    <div id="main-menu">
        <h1 style="color:#8b5a2b">BUCKSHOT ONLINE</h1>
        <div style="margin-bottom:20px; color:#555">ОНЛАЙН: <span id="online-cnt">0</span></div>
        <button class="btn" onclick="startSingle()">ОДИНОЧНАЯ ИГРА</button>
        <button class="btn" style="color:#0f0" onclick="startMulti()">МУЛЬТИПЛЕЕР</button>
        <p id="menu-status" style="color:#0f0; margin-top:10px"></p>
    </div>

    <div id="game-ui">
        <div id="flash-effect" class="flash"></div>
        
        <div class="hp-section">
            <div id="opp-name" style="font-size:12px; color:#888">ПРОТИВНИК</div>
            <div class="hp-bar" id="opp-hp"></div>
            <div class="opp-inv" id="opp-inv"></div>
        </div>

        <div id="table">
            <div id="info-box">ОЖИДАНИЕ ХОДА...</div>
            <img id="gun" src="Gun.png">
        </div>

        <div id="player-area">
            <div style="text-align:center; font-size:11px; color:#666; margin-bottom:5px;">
                БОЕВЫЕ: <span id="l-cnt" style="color:red">?</span> | ХОЛОСТЫЕ: <span id="b-cnt" style="color:gray">?</span>
            </div>
            <div class="hp-bar" style="justify-content:center" id="my-hp"></div>
            <div class="inventory" id="my-inv"></div>
            <div class="controls">
                <button id="b-self" class="btn-act" onclick="shoot('self')">В СЕБЯ</button>
                <button id="b-opp" class="btn-act" onclick="shoot('opp')">В ВРАГА</button>
            </div>
        </div>
    </div>

<script>
    const socket = io("https://bucshot.onrender.com");
    let tgName = window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || "Игрок";

    const IMGS = {
        'Beer': 'Beer.png', 'Knife': 'Hand saw.png', 'Cigaretes': 'cigaretes.png',
        'Handclifs': 'Handclifs.png', 'Lighter': 'Lighter.png',
        'hpFull': 'Health_2.png', 'hpEmpty': 'Health_1.png'
    };

    let state = {
        mode: 'none', roomId: null, turn: false, processing: false,
        myHP: 3, oppHP: 3, mag: [], myInv: [], oppInv: [], dmg: 1
    };

    const playSnd = (id) => { const a = document.getElementById('snd-'+id); a.currentTime=0; a.play().catch(()=>{}); };

    socket.on('online_count', c => document.getElementById('online-cnt').innerText = c);

    // --- МУЛЬТИПЛЕЕР ---
    function startMulti() {
        document.getElementById('menu-status').innerText = "ПОИСК...";
        socket.emit('join_game', { name: tgName });
        playSnd('bg');
    }

    socket.on('start_multiplayer', d => {
        state = { ...state, mode: 'multi', roomId: d.id, mag: d.magazine, myInv: d.myInv, oppInv: d.oppInv, turn: d.turn };
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('opp-name').innerText = d.oppName;
        render();
    });

    socket.on('opponent_action', d => {
        if (d.type === 'shoot') {
            state.mag.shift();
            visualShoot(d.target === 'self' ? 'opp' : 'self', d.bullet, false);
        } else if (d.type === 'item') {
            applyItem(d.item, false);
        }
    });

    socket.on('reload_magazine', d => {
        setTimeout(() => {
            playSnd('reload');
            state.mag = d.magazine;
            state.myInv = [...state.myInv, ...d.newItems].slice(0, 8);
            state.oppInv = [...state.oppInv, ...d.newItems].slice(0, 8);
            render();
        }, 2000);
    });

    // --- ЛОГИКА ---
    function shoot(target) {
        if (!state.turn || state.processing) return;
        const bullet = state.mag.shift();
        if (state.mode === 'multi') socket.emit('game_action', { roomId: state.roomId, type: 'shoot', target, bullet });
        visualShoot(target, bullet, true);
    }

    function visualShoot(target, isLive, isMe) {
        state.processing = true; render();
        const gun = document.getElementById('gun');
        if (isMe) gun.style.transform = target === 'self' ? 'rotate(180deg) translateY(40px)' : 'translateX(50px)';
        else gun.style.transform = target === 'self' ? 'translateX(-50px)' : 'rotate(180deg) translateY(-40px)';

        setTimeout(() => {
            playSnd(isLive ? 'live' : 'blank');
            if (isLive) {
                const f = document.getElementById('flash-effect'); f.style.opacity = 1; setTimeout(()=>f.style.opacity=0, 100);
                let d = state.dmg;
                if (target === 'self') isMe ? state.myHP-=d : state.oppHP-=d;
                else isMe ? state.oppHP-=d : state.myHP-=d;
            }
            state.dmg = 1;

            setTimeout(() => {
                gun.style.transform = 'none';
                let stay = (!isLive && target === 'self');
                state.turn = isMe ? stay : !stay;
                state.processing = false;
                render();
                if (state.myHP<=0 || state.oppHP<=0) { alert("КОНЕЦ ИГРЫ"); location.reload(); }
                if (state.mode === 'single' && !state.turn) setTimeout(ai, 1000);
            }, 800);
        }, 500);
    }

    function useItem(it, idx) {
        if (!state.turn || state.processing) return;
        state.myInv.splice(idx, 1);
        if (state.mode === 'multi') socket.emit('game_action', { roomId: state.roomId, type: 'item', item: it });
        applyItem(it, true);
    }

    function applyItem(it, isMe) {
        playSnd('item');
        const alert = document.createElement('div'); alert.className = 'item-alert';
        alert.innerText = (isMe ? "ВЫ: " : "ВРАГ: ") + it.toUpperCase();
        document.getElementById('table').appendChild(alert);
        setTimeout(()=>alert.remove(), 2000);

        if (!isMe) { const i = state.oppInv.indexOf(it); if(i>-1) state.oppInv.splice(i,1); }
        
        if (it === 'Beer') { state.mag.shift(); playSnd('reload'); }
        if (it === 'Knife') state.dmg = 2;
        if (it === 'Cigaretes') isMe ? state.myHP=Math.min(3, state.myHP+1) : state.oppHP=Math.min(3, state.oppHP+1);
        if (it === 'Lighter' && isMe) document.getElementById('info-box').innerText = "СЛЕДУЮЩИЙ: " + (state.mag[0]?"БОЕВОЙ":"ХОЛОСТОЙ");
        
        render();
    }

    function render() {
        const hp = (id, n) => {
            const el = document.getElementById(id); el.innerHTML = '';
            for(let i=0; i<3; i++) el.innerHTML += `<div class="hp-icon" style="background-image:url(${i<n?IMGS.hpFull:IMGS.hpEmpty})"></div>`;
        };
        hp('my-hp', state.myHP); hp('opp-hp', state.oppHP);

        const inv = document.getElementById('my-inv'); inv.innerHTML = '';
        state.myInv.forEach((it, i) => {
            const b = document.createElement('div'); b.className = 'item-btn';
            b.style.backgroundImage = `url(${IMGS[it]})`; b.onclick = () => useItem(it, i);
            inv.appendChild(b);
        });

        const oinv = document.getElementById('opp-inv'); oinv.innerHTML = '';
        state.oppInv.forEach(it => {
            const d = document.createElement('div'); d.className = 'item-mini';
            d.style.backgroundImage = `url(${IMGS[it]})`; oinv.appendChild(d);
        });

        document.getElementById('l-cnt').innerText = state.mag.filter(x=>x).length;
        document.getElementById('b-cnt').innerText = state.mag.filter(x=>!x).length;
        document.getElementById('info-box').innerText = state.turn ? "ВАШ ХОД" : "ХОД ВРАГА";
        document.getElementById('b-self').disabled = !state.turn || state.processing;
        document.getElementById('b-opp').disabled = !state.turn || state.processing;
    }

    // --- ОДИНОЧКА ---
    function startSingle() {
        state.mode = 'single'; state.turn = true; state.mag = [true, false, true, false].sort(()=>Math.random()-0.5);
        state.myInv = ['Beer', 'Cigaretes']; state.oppInv = ['Knife'];
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        render();
    }
    function ai() { if(state.mag.length===0) { state.mag=[true,false]; render(); } actShoot('opp'); }
</script>
</body>
</html>
