<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Roulette Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; user-select: none; }
        
        #main-menu { position: absolute; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 6px solid #5d3a1a; box-sizing: border-box;}
        .btn { padding: 15px; width: 240px; margin: 10px; background: #1a1a1a; border: 2px solid #5d3a1a; color: #fff; font-weight: bold; cursor: pointer; }
        
        #game-ui { position: relative; width: 100%; height: 100%; max-width: 500px; display: none; flex-direction: column; background: #0a0a0a; border: 2px solid #332211; box-sizing: border-box;}
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-panel { background: #111; padding: 10px; border-bottom: 2px solid #5d3a1a; display: flex; flex-direction: column; align-items: center; z-index: 60;}
        .hp-bar { display: flex; gap: 4px; margin: 5px 0; height: 30px; }
        .hp-icon { width: 20px; height: 30px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .inv-mini { display: flex; gap: 3px; height: 25px; opacity: 0.6; }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #table { flex-grow: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; background: url('Game_Table.png') no-repeat center; background-size: cover; }
        #gun { width: 75%; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 10; filter: drop-shadow(0 0 10px #000); }
        
        /* –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ */
        #game-log { position: absolute; top: 20px; width: 90%; background: rgba(0,0,0,0.85); border: 2px solid #5d3a1a; color: #0f0; padding: 8px; font-size: 14px; text-align: center; z-index: 100; min-height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #player-panel { background: #000; padding: 15px; border-top: 2px solid #5d3a1a; }
        .inv-main { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; min-height: 55px; margin: 10px 0; }
        .item-btn { width: 45px; height: 45px; border: 1px solid #5d3a1a; background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #111; cursor: pointer; }
        .item-btn:active { background-color: #333; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-shoot { padding: 18px; background: #1a1a1a; border: 1px solid #5d3a1a; color: #fff; font-weight: bold; cursor: pointer; font-size: 14px;}
        .btn-shoot:disabled { opacity: 0.1; }

        .flash { position: absolute; inset: 0; background: #fff; opacity: 0; z-index: 100; pointer-events: none; }
        .dmg-indicator { color: red; font-weight: bold; position: absolute; bottom: 10px; right: 10px; font-size: 20px; display: none; }
    </style>
</head>
<body>

    <div id="main-menu">
        <h1 style="color:#8b5a2b; letter-spacing:2px;">BUCKSHOT ONLINE</h1>
        <div style="color:#444; margin-bottom:20px;">–û–ù–õ–ê–ô–ù: <span id="online-cnt">0</span></div>
        <button class="btn" onclick="startSingle()">–û–î–ò–ù–û–ß–ù–ê–Ø –ò–ì–†–ê</button>
        <button class="btn" style="color:#0f0; border-color:#0f0;" onclick="startMulti()">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</button>
        <p id="menu-status"></p>
    </div>

    <div id="game-ui">
        <div id="flash-effect" class="flash"></div>
        
        <div class="top-panel">
            <div id="opp-name" style="font-size:10px; color:#aaa; margin-bottom:2px;">–ü–†–û–¢–ò–í–ù–ò–ö</div>
            <div class="hp-bar" id="opp-hp"></div>
            <div class="inv-mini" id="opp-inv"></div>
        </div>

        <div id="table">
            <div id="game-log">–û–ñ–ò–î–ê–ù–ò–ï...</div>
            <img id="gun" src="Gun.png">
            <div id="dmg-view" class="dmg-indicator">–£–†–û–ù x2</div>
        </div>

        <div id="player-panel">
            <div style="text-align:center; font-size:10px; color:#555; margin-bottom:8px;">
                –ë–û–ï–í–´–ï: <span id="l-cnt" style="color:#f44">?</span> | –•–û–õ–û–°–¢–´–ï: <span id="b-cnt" style="color:#888">?</span>
            </div>
            <div class="hp-bar" style="justify-content:center;" id="my-hp"></div>
            <div class="inv-main" id="my-inv"></div>
            <div class="controls">
                <button id="btn-self" class="btn-shoot" onclick="doShoot('self')">–í –°–ï–ë–Ø</button>
                <button id="btn-opp" class="btn-shoot" onclick="doShoot('opp')">–í –í–†–ê–ì–ê</button>
            </div>
        </div>
    </div>

    <audio id="snd-bg" src="background_music.mp3" loop></audio>
    <audio id="snd-live" src="shot_live.mp3"></audio>
    <audio id="snd-blank" src="shot_blank.mp3"></audio>
    <audio id="snd-reload" src="reload.mp3"></audio>
    <audio id="snd-item" src="item_use.mp3"></audio>

<script>
    const socket = io("https://bucshot.onrender.com");
    let tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";

    const IMGS = {
        'Beer': 'Beer.png', 
        'Knife': 'Hand saw.png', 
        'Cigaretes': 'cigaretes.png',
        'Handclifs': 'Handclifs.png', 
        'Lighter': 'Lighter.png',
        'hpFull': 'Health_2.png', 
        'hpEmpty': 'Health_1.png'
    };

    let state = {
        mode: 'none', roomId: null, turn: false, processing: false,
        myHP: 3, oppHP: 3, mag: [], myInv: [], oppInv: [], dmg: 1
    };

    const playSnd = (id) => { 
        const a = document.getElementById('snd-' + id);
        if(a) { a.currentTime = 0; a.play().catch(()=>{}); }
    };

    const log = (txt) => { document.getElementById('game-log').innerText = txt; };

    socket.on('online_count', c => document.getElementById('online-cnt').innerText = c);

    function startMulti() {
        document.getElementById('menu-status').innerText = "–ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...";
        socket.emit('join_game', { name: tgUser });
        playSnd('bg');
    }

    socket.on('start_multiplayer', d => {
        state.mode = 'multi'; state.roomId = d.id; state.mag = d.magazine;
        state.myInv = d.myInv; state.oppInv = d.oppInv; state.turn = d.turn;
        state.myHP = 3; state.oppHP = 3; state.dmg = 1;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('opp-name').innerText = d.oppName;
        render();
    });

    socket.on('opponent_action', d => {
        if (d.type === 'shoot') {
            const bullet = state.mag.shift();
            visualShoot(d.target === 'self' ? 'opp' : 'self', bullet, false);
        } else if (d.type === 'item') {
            applyItem(d.item, false);
        }
    });

    socket.on('reload_magazine', d => {
        state.processing = true;
        log("–ü–ï–†–ï–ó–ê–†–Ø–î–ö–ê...");
        setTimeout(() => {
            playSnd('reload');
            state.mag = d.magazine;
            state.myInv = [...state.myInv, ...d.newItems].slice(0, 8);
            state.oppInv = [...state.oppInv, ...d.newItems].slice(0, 8);
            state.processing = false;
            render();
        }, 1500);
    });

    function doShoot(target) {
        if (!state.turn || state.processing) return;
        const bullet = state.mag.shift();
        if (state.mode === 'multi') {
            socket.emit('game_action', { roomId: state.roomId, type: 'shoot', target, bullet });
        }
        visualShoot(target, bullet, true);
    }

    function visualShoot(target, isLive, isMe) {
        state.processing = true;
        render();
        const gun = document.getElementById('gun');

        if (isMe) gun.style.transform = target === 'self' ? 'rotate(180deg) translateY(40px)' : 'translateX(60px)';
        else gun.style.transform = target === 'self' ? 'translateX(-60px)' : 'rotate(180deg) translateY(-40px)';

        setTimeout(() => {
            playSnd(isLive ? 'live' : 'blank');
            if (isLive) {
                const f = document.getElementById('flash-effect'); 
                f.style.opacity = 1; setTimeout(() => f.style.opacity = 0, 100);
                
                let d = state.dmg;
                if (target === 'self') isMe ? state.myHP -= d : state.oppHP -= d;
                else isMe ? state.oppHP -= d : state.myHP -= d;
            }
            
            state.dmg = 1;
            document.getElementById('dmg-view').style.display = 'none';

            setTimeout(() => {
                gun.style.transform = 'none';
                let stayTurn = (!isLive && target === 'self');
                
                if (isMe) state.turn = stayTurn;
                else state.turn = !stayTurn;

                state.processing = false;
                
                if (state.myHP <= 0 || state.oppHP <= 0) {
                    alert(state.myHP > 0 ? "–í–´ –ü–û–ë–ï–î–ò–õ–ò!" : "–í–´ –ü–†–û–ò–ì–†–ê–õ–ò");
                    location.reload();
                    return;
                }
                render();
            }, 800);
        }, 500);
    }

    function useItem(it, idx) {
        if (!state.turn || state.processing) return;
        state.myInv.splice(idx, 1);
        if (state.mode === 'multi') {
            socket.emit('game_action', { roomId: state.roomId, type: 'item', item: it });
        }
        applyItem(it, true);
    }

    function applyItem(it, isMe) {
        playSnd('item');
        let user = isMe ? "–í–´" : "–í–†–ê–ì";
        
        if (!isMe) {
            const idx = state.oppInv.indexOf(it);
            if (idx > -1) state.oppInv.splice(idx, 1);
        }

        if (it === 'Beer') {
            const b = state.mag.shift();
            log(`${user} –≤—ã–ø–∏–ª –ø–∏–≤–æ. –í—ã–±—Ä–æ—à–µ–Ω: ${b ? "–ë–û–ï–í–û–ô üî•" : "–•–û–õ–û–°–¢–û–ô ‚ùÑÔ∏è"}`);
            playSnd('reload');
        } else if (it === 'Knife') {
            state.dmg = 2;
            log(`${user} –æ—Ç–ø–∏–ª–∏–ª —Å—Ç–≤–æ–ª. –£–†–û–ù x2!`);
            document.getElementById('dmg-view').style.display = 'block';
        } else if (it === 'Cigaretes') {
            if (isMe) state.myHP = Math.min(3, state.myHP + 1);
            else state.oppHP = Math.min(3, state.oppHP + 1);
            log(`${user} –∑–∞–∫—É—Ä–∏–ª. +1 –ó–¥–æ—Ä–æ–≤—å–µ`);
        } else if (it === 'Lighter') {
            if (isMe) log(`–ó–∞–∂–∏–≥–∞–ª–∫–∞: —Å–ª–µ–¥—É—é—â–∏–π –ø–∞—Ç—Ä–æ–Ω ${state.mag[0] ? "–ë–û–ï–í–û–ô üî•" : "–•–û–õ–û–°–¢–û–ô ‚ùÑÔ∏è"}`);
            else log(`–í—Ä–∞–≥ –∑–∞–≥–ª—è–Ω—É–ª –≤ —Å—Ç–≤–æ–ª –∑–∞–∂–∏–≥–∞–ª–∫–æ–π...`);
        } else if (it === 'Handclifs') {
            log(`${user} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–∞—Ä—É—á–Ω–∏–∫–∏. –•–æ–¥ –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω!`);
        }
        
        render();
    }

    function render() {
        const drawHP = (id, val) => {
            const el = document.getElementById(id); el.innerHTML = '';
            for(let i=0; i<3; i++) {
                const img = document.createElement('div');
                img.className = 'hp-icon';
                img.style.backgroundImage = `url(${i < val ? IMGS.hpFull : IMGS.hpEmpty})`;
                el.appendChild(img);
            }
        };
        drawHP('my-hp', state.myHP);
        drawHP('opp-hp', state.oppHP);

        const myInvEl = document.getElementById('my-inv'); myInvEl.innerHTML = '';
        state.myInv.forEach((it, i) => {
            const b = document.createElement('button');
            b.className = 'item-btn';
            b.style.backgroundImage = `url("${IMGS[it]}")`;
            b.disabled = !state.turn || state.processing;
            b.onclick = () => useItem(it, i);
            myInvEl.appendChild(b);
        });

        const oppInvEl = document.getElementById('opp-inv'); oppInvEl.innerHTML = '';
        state.oppInv.forEach(it => {
            const d = document.createElement('div');
            d.className = 'item-mini';
            d.style.backgroundImage = `url("${IMGS[it]}")`;
            oppInvEl.appendChild(d);
        });

        document.getElementById('l-cnt').innerText = state.mag.filter(x => x).length;
        document.getElementById('b-cnt').innerText = state.mag.filter(x => !x).length;

        const canAct = state.turn && !state.processing;
        document.getElementById('btn-self').disabled = !canAct;
        document.getElementById('btn-opp').disabled = !canAct;

        if (!state.processing) {
            if (document.getElementById('game-log').innerText.indexOf('–≤—ã–ø–∏–ª') === -1) {
                log(state.turn ? "–í–ê–® –•–û–î" : "–•–û–î –ü–†–û–¢–ò–í–ù–ò–ö–ê...");
            }
        }
    }

    function startSingle() {
        state.mode = 'single'; state.turn = true;
        state.mag = [true, false, true, false].sort(() => Math.random() - 0.5);
        state.myInv = ['Beer', 'Cigaretes', 'Knife']; state.oppInv = ['Lighter'];
        state.myHP = 3; state.oppHP = 3; state.dmg = 1;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        render();
    }
</script>
</body>
</html>
