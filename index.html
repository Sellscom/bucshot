<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .top-btn { position: absolute; z-index: 1000; background: rgba(0,0,0,0.6); border: 1px solid #5d3a1a; color: #fff; padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-size: 12px; }
        #mute-btn { top: 10px; right: 10px; }
        
        #main-menu { position: absolute; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 10px solid #5d3a1a; box-sizing: border-box; }
        #game-outer-border { position: relative; width: 100vw; height: 100vh; max-width: 500px; border: 10px solid #5d3a1a; background: #000; display: none; flex-direction: column; }
        
        .health-bar { display: flex; gap: 5px; padding: 10px; background: rgba(0,0,0,0.8); justify-content: center; min-height: 30px; }
        .hp-icon { width: 18px; height: 28px; background-size: contain; background-repeat: no-repeat; border: 1px solid #333; }
        
        #central-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .status-text { background: rgba(0,0,0,0.9); padding: 10px; border: 1px solid #5d3a1a; color: #0f0; width: 80%; text-align: center; min-height: 50px; font-size: 14px; z-index: 10; }
        
        #gun-img { width: 70%; transition: transform 0.2s; z-index: 5; }
        .inventory-box { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; padding: 10px; background: #111; min-height: 50px; border-top: 1px solid #5d3a1a; }
        .item-btn { width: 45px; height: 45px; border: 1px solid #5d3a1a; background-color: #222; background-size: cover; cursor: pointer; }
        
        #ammo-info { background: #000; padding: 8px; text-align: center; font-size: 12px; border-top: 1px solid #5d3a1a; color: #ccc; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; }
        .action-btn { padding: 16px; border: 1px solid #5d3a1a; background: #1a1a1a; color: #fff; cursor: pointer; font-weight: bold; }
        .action-btn:disabled { opacity: 0.2; }
    </style>
</head>
<body>

    <audio id="snd-bg" src="background_music.mp3" loop></audio>
    <audio id="snd-live" src="shot_live.mp3"></audio>
    <audio id="snd-blank" src="shot_blank.mp3"></audio>

    <button id="mute-btn" class="top-btn" onclick="toggleMute()">ЗВУК: ВКЛ</button>

    <div id="main-menu">
        <h1 style="color: #8b5a2b;">BUCKSHOT ONLINE</h1>
        <button class="action-btn" style="width: 260px;" onclick="startMulti()">НАЙТИ ОППОНЕНТА</button>
        <p id="search-status" style="color: #0f0; font-size: 12px; margin-top: 10px;"></p>
    </div>

    <div id="game-outer-border">
        <div class="health-bar" id="opp-hp"></div>
        <div id="central-area">
            <div id="info" class="status-text">ПОДГОТОВКА...</div>
            <img src="https://i.imgur.com/8mX3BfT.png" id="gun-img">
        </div>
        <div id="ammo-info">БОЕВЫЕ: <span id="c-live" style="color:red">0</span> | ХОЛОСТЫЕ: <span id="c-blank" style="color:gray">0</span></div>
        <div class="health-bar" id="my-hp"></div>
        <div class="inventory-box" id="my-inventory"></div>
        <div class="controls">
            <button id="btn-self" class="action-btn" onclick="shoot('self')">В СЕБЯ</button>
            <button id="btn-opp" class="action-btn" onclick="shoot('opponent')">В ВРАГА</button>
        </div>
    </div>

<script>
    const socket = io("https://bucshot.onrender.com");
    let multiplayerId = null;
    let isMuted = false;

    const IMGS = {
        'hpFull': 'https://i.imgur.com/vH9I5D9.png', 
        'hpEmpty': 'https://i.imgur.com/T0b4Dsh.png',
        'Beer': 'https://i.imgur.com/W2O7rVq.png',
        'Knife': 'https://i.imgur.com/86m2YwG.png', // Заглушки
        'Cigaretes': 'https://i.imgur.com/Uf7V1O1.png'
    };

    let state = {
        myHP: 3, oppHP: 3,
        magazine: [], isMyTurn: false,
        myInv: []
    };

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('snd-bg').muted = isMuted;
        document.getElementById('mute-btn').innerText = isMuted ? "ЗВУК: ВЫКЛ" : "ЗВУК: ВКЛ";
    }

    function startMulti() {
        document.getElementById('search-status').innerText = "ПОИСК...";
        socket.emit('join_game');
    }

    socket.on('start_multiplayer', (data) => {
        multiplayerId = data.id;
        state.magazine = data.magazine;
        state.isMyTurn = (data.turn === socket.id);
        state.myInv = data.myInv;
        
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-outer-border').style.display = 'flex';
        
        const bg = document.getElementById('snd-bg');
        bg.volume = 0.3;
        bg.play().catch(() => console.log("Нужен клик для музыки"));
        
        updateUI();
    });

    socket.on('opponent_move', (data) => {
        if(data.type === 'shoot') {
            const bullet = state.magazine.shift();
            executeVisualShot(data.target === 'self' ? 'opponent' : 'self', bullet, false);
        }
    });

    function updateUI() {
        const drawHP = (id, count) => {
            const el = document.getElementById(id); el.innerHTML = '';
            for(let i=0; i<3; i++) {
                const div = document.createElement('div');
                div.className = 'hp-icon';
                div.style.backgroundImage = `url(${i < count ? IMGS.hpFull : IMGS.hpEmpty})`;
                el.appendChild(div);
            }
        };
        drawHP('my-hp', state.myHP);
        drawHP('opp-hp', state.oppHP);

        const invBox = document.getElementById('my-inventory');
        invBox.innerHTML = '';
        state.myInv.forEach((item, idx) => {
            const btn = document.createElement('div');
            btn.className = 'item-btn';
            btn.style.backgroundImage = `url(${IMGS[item] || ''})`;
            btn.onclick = () => useItem(idx);
            invBox.appendChild(btn);
        });

        document.getElementById('c-live').innerText = state.magazine.filter(b => b).length;
        document.getElementById('c-blank').innerText = state.magazine.filter(b => !b).length;
        document.getElementById('info').innerText = state.isMyTurn ? "ВАШ ХОД" : "ОЖИДАНИЕ ХОДА ВРАГА...";
        
        document.getElementById('btn-self').disabled = !state.isMyTurn;
        document.getElementById('btn-opp').disabled = !state.isMyTurn;
    }

    function shoot(target) {
        if (!state.isMyTurn) return;
        const bullet = state.magazine.shift();
        socket.emit('make_move', { roomId: multiplayerId, type: 'shoot', target, bullet });
        executeVisualShot(target, bullet, true);
    }

    function executeVisualShot(target, isLive, isMe) {
        state.isMyTurn = false; // Блокируем кнопки
        updateUI();

        const gun = document.getElementById('gun-img');
        if (isMe) gun.style.transform = target === 'self' ? 'rotate(180deg) translateY(30px)' : 'translateX(40px)';
        else gun.style.transform = target === 'self' ? 'translateX(-40px)' : 'rotate(180deg) translateY(-30px)';

        setTimeout(() => {
            const snd = isLive ? document.getElementById('snd-live') : document.getElementById('snd-blank');
            if(!isMuted) snd.play();

            if (isLive) {
                if (target === 'self') isMe ? state.myHP-- : state.oppHP--;
                else isMe ? state.oppHP-- : state.myHP--;
            }
            
            setTimeout(() => {
                gun.style.transform = 'none';
                
                // ЛОГИКА ПЕРЕДАЧИ ХОДА:
                // Если был холостой в себя — ход сохраняется за тем, кто стрелял.
                if (!isLive && target === 'self') {
                    state.isMyTurn = isMe;
                } else {
                    state.isMyTurn = !isMe;
                }

                if (state.magazine.length === 0) {
                    // Конец патронов — можно добавить логику перезарядки
                    document.getElementById('info').innerText = "ПУСТО. ПЕРЕЗАРЯДКА...";
                }

                updateUI();
                if (state.myHP <= 0 || state.oppHP <= 0) {
                    alert(state.myHP > 0 ? "ПОБЕДА!" : "ВЫ ПРОИГРАЛИ");
                    location.reload();
                }
            }, 600);
        }, 400);
    }

    function useItem(idx) {
        if(!state.isMyTurn) return;
        const item = state.myInv[idx];
        alert("Использован предмет: " + item);
        state.myInv.splice(idx, 1);
        updateUI();
        // Здесь можно добавить socket.emit('make_move', {type: 'item', item})
    }
</script>
</body>
</html>
