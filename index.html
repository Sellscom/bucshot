<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Roulette</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --br: #5d3a1a; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        .screen { position: absolute; inset: 0; background: #000; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid var(--br); box-sizing: border-box; }
        .btn { padding: 12px; width: 220px; margin: 5px; background: #111; border: 2px solid var(--br); color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        
        /* –ü—Ä–∞–≤–∏–ª–∞ */
        #rules-screen { display: none; padding: 20px; text-align: left; overflow-y: auto; align-items: flex-start; justify-content: flex-start; }
        .rule-item { margin-bottom: 10px; font-size: 13px; color: #ccc; }
        .rule-item b { color: #f00; }

        #game-ui { position: relative; width: 100%; height: 100vh; display: none; flex-direction: column; max-width: 500px; margin: 0 auto; }
        #table { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #1a1a1a; border: 4px solid var(--br); margin: 5px; }
        #gun { width: 70%; transition: 0.4s; }
        #game-log { position: absolute; top: 10px; width: 90%; background: rgba(0,0,0,0.8); border: 1px solid var(--br); color: #0f0; padding: 8px; text-align: center; z-index: 100; font-size: 12px; }
        .inv { display: flex; gap: 5px; padding: 10px; justify-content: center; min-height: 40px; }
        .item-btn { width: 40px; height: 40px; border: 1px solid var(--br); background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #111; }
        .hp-bar { display: flex; gap: 4px; padding: 5px; }
        .hp-icon { width: 15px; height: 22px; background-size: contain; background-repeat: no-repeat; }
    </style>
</head>
<body>

    <div id="menu" class="screen">
        <h1 style="color:var(--br)">BUCKSHOT ROULETTE</h1>
        <div id="online-count" style="font-size: 12px; color: #555; margin-bottom: 10px;">–í –°–ï–¢–ò: 0</div>
        <button class="btn" onclick="startMode('multi')">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</button>
        <button class="btn" onclick="startMode('single')">–û–î–ò–ù–û–ß–ù–´–ô –†–ï–ñ–ò–ú</button>
        <button class="btn" onclick="toggleRules(true)">–ü–†–ê–í–ò–õ–ê –ò –ü–†–ï–î–ú–ï–¢–´</button>
    </div>

    <div id="rules-screen" class="screen">
        <h2 style="color:var(--br)">–ü–†–ê–í–ò–õ–ê –ò–ì–†–´</h2>
        <div class="rule-item">1. –ó–∞—Ä—è–∂–∞–µ—Ç—Å—è –º–∞–≥–∞–∑–∏–Ω —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º —á–∏—Å–ª–æ–º <b>–±–æ–µ–≤—ã—Ö</b> –∏ <b>—Ö–æ–ª–æ—Å—Ç—ã—Ö</b> –ø–∞—Ç—Ä–æ–Ω–æ–≤.</div>
        <div class="rule-item">2. –í—ã—Å—Ç—Ä–µ–ª –≤ —Å–µ–±—è —Ö–æ–ª–æ—Å—Ç—ã–º ‚Äî <b>—Ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</b>.</div>
        <div class="rule-item">3. –í—ã—Å—Ç—Ä–µ–ª –≤ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞ –∏–ª–∏ –±–æ–µ–≤—ã–º –≤ —Å–µ–±—è ‚Äî <b>—Ö–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è</b>.</div>
        <h2 style="color:var(--br)">–ü–†–ï–î–ú–ï–¢–´</h2>
        <div class="rule-item">üç∫ <b>–ü–∏–≤–æ:</b> –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—Ä–æ–Ω –∏–∑ —Å—Ç–≤–æ–ª–∞.</div>
        <div class="rule-item">üî™ <b>–ù–æ–∂:</b> –°–ª–µ–¥—É—é—â–∏–π –±–æ–µ–≤–æ–π –ø–∞—Ç—Ä–æ–Ω –Ω–∞–Ω–µ—Å–µ—Ç <b>2 —É—Ä–æ–Ω–∞</b>.</div>
        <div class="rule-item">üö¨ <b>–°–∏–≥–∞—Ä–µ—Ç—ã:</b> –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç 1 –µ–¥–∏–Ω–∏—Ü—É –∑–¥–æ—Ä–æ–≤—å—è.</div>
        <div class="rule-item">üîó <b>–ù–∞—Ä—É—á–Ω–∏–∫–∏:</b> –û–ø–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.</div>
        <div class="rule-item">üîç <b>–õ—É–ø–∞:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç —É–≤–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—Ä–æ–Ω.</div>
        <button class="btn" onclick="toggleRules(false)" style="margin-top: 20px;">–ù–ê–ó–ê–î</button>
    </div>

    <div id="game-ui">
        <div id="game-log">–û–ñ–ò–î–ê–ù–ò–ï...</div>
        <div id="opp-panel">
            <center><div id="opp-hp" class="hp-bar"></div></center>
            <div id="opp-inv" class="inv"></div>
        </div>
        <div id="table">
            <img id="gun" src="Gun.png">
        </div>
        <div id="player-panel">
            <center><div id="my-hp" class="hp-bar"></div></center>
            <div id="my-inv" class="inv"></div>
            <div style="display:flex; justify-content:center; gap:10px; padding-bottom: 20px;">
                <button id="btn-self" class="btn" style="width:140px" onclick="fire('self')">–í –°–ï–ë–Ø</button>
                <button id="btn-opp" class="btn" style="width:140px" onclick="fire('opp')">–í –í–†–ê–ì–ê</button>
            </div>
        </div>
    </div>

<script>
    const socket = io();
    let state = { mode: 'multi', turn: false, processing: false, roomId: null, myHP: 3, oppHP: 3, mag: [], myInv: [] };
    const IMGS = { 'hpFull': 'Health_2.png', 'hpEmpty': 'Health_1.png', 'Beer': 'Beer.png', 'Knife': 'Hand saw.png', 'Cigaretes': 'cigaretes.png' };

    socket.on('update_online', n => document.getElementById('online-count').innerText = `–í –°–ï–¢–ò: ${n}`);
    function toggleRules(show) { document.getElementById('rules-screen').style.display = show ? 'flex' : 'none'; }

    function startMode(m) {
        state.mode = m;
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        if (m === 'multi') {
            socket.emit('join_game');
        } else {
            initSinglePlayer();
        }
    }

    // --- –õ–û–ì–ò–ö–ê –û–î–ò–ù–û–ß–ù–û–ì–û –†–ï–ñ–ò–ú–ê ---
    function initSinglePlayer() {
        state.myHP = 3; state.oppHP = 3; state.turn = true;
        state.mag = [true, false, true, false].sort(() => Math.random() - 0.5);
        state.myInv = ['Beer', 'Cigaretes'];
        render();
        log("–û–î–ò–ù–û–ß–ù–ê–Ø –ò–ì–†–ê –ù–ê–ß–ê–¢–ê");
    }

    function fire(target) {
        if (!state.turn || state.processing) return;
        if (state.mode === 'multi') {
            socket.emit('game_action', { roomId: state.roomId, type: 'shoot', target });
        } else {
            executeShot(target, true);
        }
    }

    function executeShot(target, isPlayer) {
        state.processing = true;
        const isLive = state.mag.shift();
        
        // –í–∏–∑—É–∞–ª
        const gun = document.getElementById('gun');
        if (isPlayer) gun.style.transform = target === 'self' ? 'rotate(180deg) translateY(40px)' : 'translateX(40px)';
        else gun.style.transform = target === 'self' ? 'translateX(-40px)' : 'rotate(180deg) translateY(-40px)';

        setTimeout(() => {
            if (isLive) {
                if (isPlayer) { if(target === 'self') state.myHP--; else state.oppHP--; }
                else { if(target === 'self') state.oppHP--; else state.myHP--; }
                state.turn = !isPlayer;
            } else {
                if (target === 'opp') state.turn = !isPlayer;
            }
            
            gun.style.transform = 'none';
            state.processing = false;
            render();
            if (state.myHP <= 0 || state.oppHP <= 0) return alert(state.myHP > 0 ? "–ü–û–ë–ï–î–ê" : "–ü–†–û–ò–ì–†–´–®");
            if (state.mag.length === 0) state.mag = [true, false, true].sort(() => Math.random() - 0.5);
            if (!state.turn) setTimeout(botBrain, 1500);
        }, 800);
    }

    function botBrain() {
        if (state.turn) return;
        executeShot(Math.random() > 0.5 ? 'self' : 'opp', false);
    }

    // --- –°–ï–¢–ï–í–ê–Ø –õ–û–ì–ò–ö–ê ---
    socket.on('init_game', d => { state.roomId = d.roomId; state.turn = d.turn; render(); });
    socket.on('action_result', d => {
        if (d.type === 'shoot') {
            state.turn = (d.nextTurn === socket.id);
            const oppId = Object.keys(d.hp).find(id => id !== socket.id);
            state.myHP = d.hp[socket.id]; state.oppHP = d.hp[oppId];
            render();
        }
    });

    function render() {
        const hp = (id, v) => {
            document.getElementById(id).innerHTML = Array(3).fill(0).map((_,i) => 
                `<div class="hp-icon" style="background-image:url(${i<v?IMGS.hpFull:IMGS.hpEmpty})"></div>`).join('');
        };
        hp('my-hp', state.myHP); hp('opp-hp', state.oppHP);
        document.getElementById('btn-self').disabled = !state.turn;
        document.getElementById('btn-opp').disabled = !state.turn;
        document.getElementById('game-log').innerText = state.turn ? "–í–ê–® –•–û–î" : "–û–ñ–ò–î–ê–ù–ò–ï –•–û–î–ê...";
    }
    function log(m) { document.getElementById('game-log').innerText = m; }
</script>
</body>
</html>
