<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Roulette Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --main-brown: #5d3a1a; --bg-dark: #0a0a0a; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: absolute; inset: 0; background: #000; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid var(--main-brown); box-sizing: border-box; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 15px; width: 240px; margin: 10px; background: #1a1a1a; border: 2px solid var(--main-brown); color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { background: #2a2a2a; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #game-ui { position: relative; width: 100%; height: 100%; max-width: 500px; display: none; flex-direction: column; background: var(--bg-dark); }
        .nav { width: 100%; display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid var(--main-brown); box-sizing: border-box; align-items: center; }
        
        #table { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; background: url('Game_Table.png') center/cover; background-color: #1a1a1a; }
        #gun { width: 75%; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 10; }
        
        #game-log { position: absolute; top: 15px; width: 85%; background: rgba(0,0,0,0.85); border: 1px solid var(--main-brown); color: #0f0; padding: 10px; text-align: center; font-size: 13px; z-index: 100; border-radius: 4px; }

        /* HP –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .hp-bar { display: flex; gap: 5px; height: 25px; margin: 5px 0; }
        .hp-icon { width: 18px; height: 25px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        .inv { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; min-height: 50px; margin: 10px 0; padding: 0 10px; }
        .item-btn { width: 48px; height: 48px; border: 1px solid var(--main-brown); background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #111; cursor: pointer; transition: 0.1s; }
        .item-btn:hover { transform: scale(1.1); background-color: #222; }

        #player-panel { background: #000; padding: 15px; border-top: 2px solid var(--main-brown); }
        .flash { position: absolute; inset: 0; background: #fff; opacity: 0; z-index: 200; pointer-events: none; }
        #dmg-x2 { color: red; position: absolute; bottom: 20px; right: 20px; font-weight: bold; display: none; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

    <div id="menu" class="screen">
        <h1 style="color:#8b5a2b; font-size: 2em; text-align: center;">BUCKSHOT ROULETTE</h1>
        <div id="online-txt" style="color:#666; margin-bottom: 20px;">–í –°–ï–¢–ò: 0</div>
        <button class="btn" onclick="joinMulti()">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</button>
        <button class="btn" onclick="startSingle()">–û–î–ò–ù–û–ß–ù–´–ô –†–ï–ñ–ò–ú</button>
    </div>

    <div id="game-ui">
        <div id="flash" class="flash"></div>
        <div class="nav">
            <button onclick="toggleMute()" id="mute-btn" style="background:none; border:1px solid #444; color:#aaa; font-size:10px; padding:5px; cursor:pointer;">–ó–í–£–ö: –í–ö–õ</button>
            <span id="round-txt" style="color:#8b5a2b">–†–ê–£–ù–î 1/3</span>
            <button onclick="location.reload()" style="background:none; border:none; color:red; font-size:12px; cursor:pointer;">–ü–û–ë–ï–ì</button>
        </div>

        <div style="display:flex; flex-direction:column; align-items:center; padding:5px;">
            <div id="opp-hp" class="hp-bar"></div>
            <div id="opp-inv" class="inv" style="transform: scale(0.85); opacity: 0.6;"></div>
        </div>

        <div id="table">
            <div id="game-log">–û–ñ–ò–î–ê–ù–ò–ï...</div>
            <img id="gun" src="Gun.png" alt="–†—É–∂—å–µ">
            <div id="dmg-x2">–£–†–û–ù x2 üî™</div>
        </div>

        <div id="player-panel">
            <div id="my-hp" class="hp-bar" style="justify-content:center;"></div>
            <div id="my-inv" class="inv"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button id="btn-self" class="btn" style="width:auto; margin:0;" onclick="handleInput('shoot','self')">–í –°–ï–ë–Ø</button>
                <button id="btn-opp" class="btn" style="width:auto; margin:0;" onclick="handleInput('shoot','opp')">–í –í–†–ê–ì–ê</button>
            </div>
        </div>
    </div>

    <audio id="snd-live" src="shot_live.mp3" preload="auto"></audio>
    <audio id="snd-blank" src="shot_blank.mp3" preload="auto"></audio>
    <audio id="snd-item" src="item_use.mp3" preload="auto"></audio>

<script>
    const socket = io();
    const IMGS = {
        'hpFull': 'Health_2.png',
        'hpEmpty': 'Health_1.png',
        'Beer': 'Beer.png',
        'Knife': 'Hand saw.png',
        'Cigaretes': 'cigaretes.png',
        'Handclifs': 'Handclifs.png',
        'Lighter': 'Lighter.png'
    };

    let state = { 
        roomId: null, turn: false, processing: false, muted: false, 
        mode: 'multi', myInv: [], oppInv: [] 
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω–∞
    socket.on('update_online', n => { document.getElementById('online-txt').innerText = `–í –°–ï–¢–ò: ${n}`; });

    function toggleMute() {
        state.muted = !state.muted;
        document.getElementById('mute-btn').innerText = state.muted ? "–ó–í–£–ö: –í–´–ö–õ" : "–ó–í–£–ö: –í–ö–õ";
    }

    function joinMulti() {
        state.mode = 'multi';
        socket.emit('join_game');
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
    }

    function startSingle() {
        alert("–û–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (–æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö)");
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã —Å–µ—Ä–≤–µ—Ä–æ–º
    socket.on('init_game', d => {
        state.roomId = d.roomId; state.turn = d.turn; 
        state.myInv = d.myInv; state.oppInv = d.oppInv;
        render(3, 3);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π (–≤—ã—Å—Ç—Ä–µ–ª/–ø—Ä–µ–¥–º–µ—Ç)
    socket.on('action_result', d => {
        const isMe = (d.actor === socket.id);
        if (d.type === 'shoot') {
            visualShoot(d.target, d.isLive, isMe, d.hp, d.nextTurn);
        } else if (d.type === 'item') {
            applyItemVisual(d.logData, isMe, d.hp);
        }
    });

    function handleInput(type, target) {
        if (!state.turn || state.processing) return;
        socket.emit('game_action', { roomId: state.roomId, type, target, item: target });
    }

    function visualShoot(target, isLive, isMe, hpMap, nextTurnId) {
        state.processing = true;
        const gun = document.getElementById('gun');
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —Ä—É–∂—å—è
        if (isMe) {
            gun.style.transform = target === 'self' ? 'rotate(180deg) translateY(40px)' : 'translateX(60px)';
        } else {
            gun.style.transform = target === 'self' ? 'translateX(-60px)' : 'rotate(180deg) translateY(-40px)';
        }

        setTimeout(() => {
            if(!state.muted) document.getElementById(isLive ? 'snd-live' : 'snd-blank').play().catch(()=>{});
            
            if(isLive) {
                document.getElementById('flash').style.opacity = 1;
                setTimeout(() => document.getElementById('flash').style.opacity = 0, 100);
            }

            setTimeout(() => {
                gun.style.transform = 'none';
                state.turn = (nextTurnId === socket.id);
                state.processing = false;
                document.getElementById('dmg-x2').style.display = 'none';
                
                const oppId = Object.keys(hpMap).find(id => id !== socket.id);
                render(hpMap[socket.id], hpMap[oppId]);
            }, 1000);
        }, 600);
    }

    function applyItemVisual(data, isMe, hpMap) {
        if(!state.muted) document.getElementById('snd-item').play().catch(()=>{});
        
        let msg = (isMe ? "–í–´: " : "–í–†–ê–ì: ") + data.item;
        if (data.item === 'Beer') msg += ` (–≤—ã–ø–∞–ª ${data.extra ? "–ë–û–ï–í–û–ô" : "–•–û–õ–û–°–¢–û–ô"})`;
        if (data.item === 'Knife') document.getElementById('dmg-x2').style.display = 'block';
        
        document.getElementById('game-log').innerText = msg;

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        const inv = isMe ? state.myInv : state.oppInv;
        const idx = inv.indexOf(data.item);
        if(idx > -1) inv.splice(idx, 1);

        const oppId = Object.keys(hpMap).find(id => id !== socket.id);
        render(hpMap[socket.id], hpMap[oppId]);
    }

    function render(mHP, oHP) {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∂–∏–∑–Ω–µ–π (–ö–∞—Ä—Ç–∏–Ω–∫–∏)
        const drawHP = (id, v) => {
            let html = '';
            for(let i=0; i<3; i++) {
                const img = i < v ? IMGS.hpFull : IMGS.hpEmpty;
                html += `<div class="hp-icon" style="background-image:url('${img}')"></div>`;
            }
            document.getElementById(id).innerHTML = html;
        };
        drawHP('my-hp', mHP); drawHP('opp-hp', oHP);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–ö–∞—Ä—Ç–∏–Ω–∫–∏)
        document.getElementById('my-inv').innerHTML = state.myInv.map(it => 
            `<div class="item-btn" style="background-image:url('${IMGS[it]}')" onclick="handleInput('item','${it}')"></div>`
        ).join('');
        
        document.getElementById('opp-inv').innerHTML = state.oppInv.map(it => 
            `<div class="item-btn" style="background-image:url('${IMGS[it]}')"></div>`
        ).join('');

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('btn-self').disabled = !state.turn || state.processing;
        document.getElementById('btn-opp').disabled = !state.turn || state.processing;
        
        if (!state.processing) {
            document.getElementById('game-log').innerText = state.turn ? "–í–ê–® –•–û–î" : "–•–û–î –ü–†–û–¢–ò–í–ù–ò–ö–ê...";
        }
    }

    socket.on('next_round', d => {
        document.getElementById('round-txt').innerText = `–†–ê–£–ù–î ${d.round}/3`;
        document.getElementById('game-log').innerText = "–ù–û–í–´–ô –†–ê–£–ù–î - HP –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û";
        render(3, 3);
    });

    socket.on('game_over', d => {
        alert(socket.id === d.winner ? "–ü–û–ë–ï–î–ê!" : "–ü–û–†–ê–ñ–ï–ù–ò–ï");
        location.reload();
    });
</script>
</body>
</html>
