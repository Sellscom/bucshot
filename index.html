<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Roulette Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .screen { position: absolute; inset: 0; background: #000; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid #5d3a1a; box-sizing: border-box; }
        .btn { padding: 15px; width: 220px; margin: 10px; background: #1a1a1a; border: 2px solid #5d3a1a; color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        #game-ui { position: relative; width: 100%; height: 100%; max-width: 500px; display: none; flex-direction: column; }
        .nav { width: 100%; display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid #5d3a1a; box-sizing: border-box; }
        #table { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #1a1a1a; overflow: hidden; }
        #gun { width: 70%; transition: transform 0.4s; z-index: 10; }
        #game-log { position: absolute; top: 20px; width: 80%; background: rgba(0,0,0,0.9); border: 1px solid #5d3a1a; color: #0f0; padding: 10px; text-align: center; font-size: 14px; z-index: 100; }
        #player-panel { background: #000; padding: 15px; border-top: 2px solid #5d3a1a; }
        .hp-bar { display: flex; gap: 5px; height: 25px; margin: 5px 0; }
        .hp-icon { width: 20px; height: 25px; background: #444; border-radius: 2px; }
        .hp-live { background: #f00; box-shadow: 0 0 5px #f00; }
        .inv { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; min-height: 45px; margin: 10px 0; }
        .item-btn { width: 45px; height: 45px; border: 1px solid #5d3a1a; background: #222; color: #fff; font-size: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; }
        .flash { position: absolute; inset: 0; background: #fff; opacity: 0; z-index: 200; pointer-events: none; }
    </style>
</head>
<body>
    <div id="menu" class="screen">
        <h1 style="color:#8b5a2b">BUCKSHOT ONLINE</h1>
        <button class="btn" onclick="join()">–ù–ê–ô–¢–ò –ò–ì–†–£</button>
    </div>

    <div id="game-ui">
        <div id="flash" class="flash"></div>
        <div class="nav">
            <span id="round-txt">–†–ê–£–ù–î 1/3</span>
            <button onclick="location.reload()" style="background:none; border:none; color:red;">–ü–û–ë–ï–ì</button>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center; padding:10px;">
            <div id="opp-hp" class="hp-bar"></div>
            <div id="opp-inv" class="inv"></div>
        </div>
        <div id="table">
            <div id="game-log">–û–ñ–ò–î–ê–ù–ò–ï...</div>
            <div id="gun" style="font-size: 50px;">üî´</div>
        </div>
        <div id="player-panel">
            <div id="my-hp" class="hp-bar" style="justify-content:center;"></div>
            <div id="my-inv" class="inv"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button id="btn-self" class="btn" style="width:auto; margin:0;" onclick="sendAction('shoot','self')">–í –°–ï–ë–Ø</button>
                <button id="btn-opp" class="btn" style="width:auto; margin:0;" onclick="sendAction('shoot','opp')">–í –í–†–ê–ì–ê</button>
            </div>
        </div>
    </div>

<script>
    // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ê–î–†–ï–° –ù–ê –í–ê–® URL –ï–°–õ–ò –ò–°–ü–û–õ–¨–ó–£–ï–¢–ï RENDER
    const socket = io(); 
    let state = { roomId: null, turn: false, processing: false, myInv: [], oppInv: [] };

    function join() { socket.emit('join_game'); document.getElementById('game-log').innerText = "–ü–û–ò–°–ö..."; }

    socket.on('init_game', d => {
        state = { ...state, roomId: d.roomId, turn: d.turn, myInv: d.myInv, oppInv: d.oppInv };
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        render(3, 3);
    });

    socket.on('action_result', d => {
        state.processing = true;
        const isMe = (d.actor === socket.id);
        const gun = document.getElementById('gun');

        if (d.type === 'shoot') {
            if (isMe) gun.style.transform = d.target === 'self' ? 'rotate(180deg) translateY(40px)' : 'translateX(60px)';
            else gun.style.transform = d.target === 'self' ? 'translateX(-60px)' : 'rotate(180deg) translateY(-40px)';

            setTimeout(() => {
                if (d.isLive) {
                    document.getElementById('flash').style.opacity = 1;
                    setTimeout(() => document.getElementById('flash').style.opacity = 0, 100);
                }
                setTimeout(() => {
                    gun.style.transform = 'none';
                    state.turn = (d.nextTurn === socket.id);
                    state.processing = false;
                    updateUI(d.hp);
                }, 1000);
            }, 600);
        } else if (d.type === 'item') {
            let msg = (isMe ? "–í–´: " : "–í–†–ê–ì: ") + d.logData.item;
            if (d.logData.item === 'Beer') msg += ` (${d.logData.extra ? "–ë–û–ï–í–û–ô" : "–•–û–õ–û–°–¢–û–ô"})`;
            document.getElementById('game-log').innerText = msg;
            
            const inv = isMe ? state.myInv : state.oppInv;
            inv.splice(inv.indexOf(d.logData.item), 1);
            state.processing = false;
            updateUI(d.hp);
        }
    });

    socket.on('next_round', d => {
        setTimeout(() => {
            document.getElementById('round-txt').innerText = `–†–ê–£–ù–î ${d.round}/3`;
            render(d.hp[socket.id], 3); // —É–ø—Ä–æ—â–µ–Ω–Ω–æ
            document.getElementById('game-log').innerText = "–ù–û–í–´–ô –†–ê–£–ù–î";
        }, 1500);
    });

    socket.on('game_over', d => {
        alert(socket.id === d.winner ? "–ü–û–ë–ï–î–ê!" : "–ü–û–†–ê–ñ–ï–ù–ò–ï");
        location.reload();
    });

    function sendAction(type, target) {
        if (!state.turn || state.processing) return;
        socket.emit('game_action', { roomId: state.roomId, type, target, item: target });
    }

    function updateUI(hpMap) {
        const oppId = Object.keys(hpMap).find(id => id !== socket.id);
        render(hpMap[socket.id], hpMap[oppId]);
    }

    function render(mHP, oHP) {
        const drawHP = (id, v) => {
            document.getElementById(id).innerHTML = Array(3).fill(0).map((_,i) => 
                `<div class="hp-icon ${i<v?'hp-live':''}"></div>`).join('');
        };
        drawHP('my-hp', mHP); drawHP('opp-hp', oHP);
        
        document.getElementById('my-inv').innerHTML = state.myInv.map(it => 
            `<div class="item-btn" onclick="sendAction('item','${it}')">${it}</div>`).join('');
        document.getElementById('opp-inv').innerHTML = state.oppInv.map(it => 
            `<div class="item-btn">${it}</div>`).join('');

        document.getElementById('btn-self').disabled = !state.turn || state.processing;
        document.getElementById('btn-opp').disabled = !state.turn || state.processing;
        if (!state.processing) document.getElementById('game-log').innerText = state.turn ? "–í–ê–® –•–û–î" : "–û–ñ–ò–î–ê–ù–ò–ï...";
    }
</script>
</body>
</html>
